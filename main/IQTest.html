{{ block title }}
Questions
{{ endblock }}

{{ block content }}
<style>
    .question-list {
        list-style: none;
    }
    img {
        width: 12rem;
    }
</style>

<ul class="question-list">
    <li>{{ formfield "briefing_1" }}</li>
    <li>{{ formfield "briefing_2" }}</li>
    <li>{{ formfield "briefing_3" }}</li>
    <li>{{ formfield "briefing_4" }}</li>
    <li>{{ formfield "briefing_5" }}</li>
    <li>{{ formfield "briefing_6" }}</li>
    <li>{{ formfield "briefing_7" }}</li>
    <li>{{ formfield "briefing_8" }}</li>
    <li>{{ formfield "briefing_9" }}</li>
    <li>{{ formfield "briefing_10" }}</li>
    <li>{{ formfield "briefing_11" }}</li>
    <li>{{ formfield "briefing_12" }}</li>
    <li>{{ formfield "briefing_13" }}</li>
    <li>{{ formfield "briefing_14" }}</li>
    <li>{{ formfield "briefing_15" }}</li>
    <li>{{ formfield "briefing_16" }}</li>
    <li>{{ formfield "briefing_17" }}</li>
    <li>{{ formfield "briefing_18" }}</li>
    <li>{{ formfield "briefing_19" }}</li>
    <li>{{ formfield "briefing_20" }}</li>
</ul>

<div style="display: flex;justify-content: center;gap:1rem">
    <button class="btn btn-outline-primary" id="btn-prev">Prev</button>
    <button class="btn btn-outline-primary" id="btn-next">Next</button>
    <button class="otree-btn-next btn btn-primary" id="btn-submit" style="display: none;">Submit</button>
</div>

<script>
    $(() => {
        const $questions = $('.question-list li');
        const $submitButton = $('#btn-submit');
        const $prevButton = $('#btn-prev');
        const $nextButton = $('#btn-next');
        let currentIndex = 0;
        $questions.hide().first().show();

        // 超时倒计时相关 - 不显示UI
        let timeLeft = 180;
        
        // 获取所有表单字段名
        const formFields = [
            'briefing_1', 'briefing_2', 'briefing_3', 'briefing_4', 'briefing_5', 
            'briefing_6', 'briefing_7', 'briefing_8', 'briefing_9', 'briefing_10', 
            'briefing_11', 'briefing_12', 'briefing_13', 'briefing_14', 'briefing_15', 
            'briefing_16', 'briefing_17', 'briefing_18', 'briefing_19', 'briefing_20'
        ];

        const toggleSubmitButton = () => {
            if (currentIndex === $questions.length - 1) {
                $submitButton.show();
            } else {
                $submitButton.hide();
            }
        };

        const toggleNavigationButtons = () => {
            $prevButton.toggle(currentIndex > 0);
            $nextButton.toggle(currentIndex < $questions.length - 1);
        };

        const validateCurrentQuestion = () => {
            const $currentQuestion = $questions.eq(currentIndex);
            const $currentField = $currentQuestion.find('input:checked, select, textarea');
        
            // Remove any existing error messages
            $currentQuestion.find('.error-message').remove();
        
            if ($currentField.length === 0) {
                // Add error message
                const $errorMessage = $('<div class="error-message text-danger" style="color: red; margin-top: 5px;">Please answer this question</div>');
                $currentQuestion.append($errorMessage);
                return false;
            }
        
            return true;
        };

        // 自动选择未回答题目的选项8
        const autoFillUnanswered = () => {
            formFields.forEach((field, index) => {
                const $fieldInputs = $(`input[name="${field}"]:checked`);
                if ($fieldInputs.length === 0) {
                    // 如果未选择，自动选择选项8
                    $(`input[name="${field}"][value="8"]`).prop('checked', true);
                }
            });
        };

        // 提交表单
        const submitForm = () => {
            // 先自动填充未答题
            autoFillUnanswered();
            // 然后提交
            $('form').submit();
        };

        $nextButton.click((e) => {
            e.preventDefault();
            
            if (!validateCurrentQuestion()) {
                // Use oTree's error handling
                const currentField = $questions.eq(currentIndex).find('input, select, textarea');
                window.otree.form.inputsWithErrors.push(currentField[0]);
                window.otree.form.showErrors();
                return;
            }

            if (currentIndex < $questions.length - 1) {
                $questions.eq(currentIndex).hide();
                currentIndex++;
                $questions.eq(currentIndex).show();
                toggleSubmitButton();
                toggleNavigationButtons();
            }
        });

        $prevButton.click((e) => {
            e.preventDefault();
            if (currentIndex > 0) {
                $questions.eq(currentIndex).hide();
                currentIndex--;
                $questions.eq(currentIndex).show();
                toggleSubmitButton();
                toggleNavigationButtons();
            }
        });

        // 修改提交按钮行为，点击前执行自动填充
        $submitButton.click((e) => {
            // 阻止默认提交行为
            e.preventDefault();
            // 执行自动填充并提交
            submitForm();
        });

        // 超时倒计时 - 隐藏计时器，但保留自动提交功能
        const timer = setInterval(() => {
            timeLeft -= 1;
            
            // 当时间到时，自动填充并提交
            if (timeLeft <= 0) {
                clearInterval(timer);
                submitForm();
            }
        }, 1000);

        // Initialize button states
        toggleSubmitButton();
        toggleNavigationButtons();
    });
</script>
{{ endblock }}